<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>QR Scanner 2.0</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding: 0;
}
.screen { display: none; padding:15px; padding-bottom:90px; }
.screen.active { display: block; }

.card {
  background:white; border-radius:16px; padding:14px; margin-top:15px;
  box-shadow:0 4px 10px rgba(0,0,0,0.08);
}

button { border:none; border-radius:14px; font-size:15px; padding:14px; cursor:pointer; }

.scan-btn { width:100%; margin:6px 0 14px; background:#34c759; color:white; font-size:16px; border-radius:14px; }
.scan-btn.off { background:#aaa; }

.call-btn { background:#34c759; width:36px; height:36px; border-radius:50%; font-size:18px; color:white; display:flex; align-items:center; justify-content:center; }
.call-btn:disabled { background:#ccc; }

.buttons { display:flex; gap:10px; margin-top:15px; }
.google { background:#4285f4; color:white; }
.apple { background:black; color:white; }
.gray { background:#ddd; }

.row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee; }
.row:last-child { border-bottom:none; }

.label { color:#888; font-size:13px; }
.value { font-size:16px; font-weight:500; word-break:break-word; }

#reader { position:relative; border-radius:16px; overflow:hidden; background:black; }
.scan-frame { position:absolute; top:50%; left:50%; width:220px; height:220px; transform:translate(-50%,-50%); border-radius:18px; border:3px solid rgba(255,255,255,0.9); box-shadow:0 0 0 2000px rgba(0,0,0,0.35); pointer-events:none; }

.history-item { padding:8px; border-bottom:1px solid #eee; font-size:14px; }
.history-item.active { background:#e5f0ff; }
.history-item.done { opacity:0.5; text-decoration:line-through; background:#d1f5d3; }
.history-item b { display:block; }

#streetHints { background:#f2f2f7; border-radius:10px; margin-top:6px; max-height:160px; overflow-y:auto; }
.street-hint { padding:10px; font-size:14px; border-bottom:1px solid #ddd; cursor:pointer; }
.street-hint:hover { background:#e5e5ea; }
.street-hint:last-child { border-bottom:none; }

#editBox { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:1000; }
#editBox .edit-content { background:#fff; margin:20% auto; padding:20px; width:85%; max-width:340px; border-radius:16px; }

#confirmBox { display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index:1000; }
#confirmBox .confirm-content { background:#fff; margin:40% auto; padding:20px; width:85%; max-width:320px; border-radius:16px; text-align:center; }

#shiftReport input { width:120px; padding:2px 6px; border-radius:6px; border:1px solid #ccc; font-size:13px; height:28px; text-align:right; }

.bottom-nav {
  position:fixed; bottom:0; left:0; right:0; height:75px; background:white;
  border-top:1px solid #ddd; display:flex; justify-content:space-around; align-items:center;
  box-shadow:0 -2px 10px rgba(0,0,0,0.08); z-index:999;
}
.bottom-nav button { background:none; border:none; font-size:14px; flex:1; height:100%; color:#666; }
.bottom-nav button.active { color:#007aff; font-weight:600; }
</style>
</head>
<body>

<!-- ===== SCREENS ===== -->
<div id="screen-scanner" class="screen">
  <h2>üì∑ QR-Scanner</h2>
  <button id="scanToggle" class="scan-btn">‚ñ∂Ô∏è Scannen</button>
  <div id="reader"></div>
  <div class="card">
    <div class="row"><div><div class="label">Adresse</div><div class="value" id="address">‚Äî</div></div></div>
    <div class="row">
      <div><div class="label">Telefon</div><div class="value" id="phone">‚Äî</div></div>
      <button class="call-btn" id="callBtn" disabled>üìû</button>
    </div>
    <div class="row"><div><div class="label">Betrag</div><div class="value" id="amount">‚Äî</div></div></div>
    <div class="buttons">
      <button class="gray" id="editBtn">‚úèÔ∏è Bearbeiten</button>
      <button class="gray" id="addBtn">‚ûï Manuell hinzuf√ºgen</button>
    </div>
  </div>
  <div class="buttons">
    <button class="google" id="googleBtn" disabled>Google Maps</button>
    <button class="apple" id="appleBtn" disabled>Apple Maps</button>
  </div>
</div>

<div id="screen-home" class="screen active">
  <div class="card">
    <div class="label">Verlauf</div>
    <div id="history"></div>
    <button id="deleteBtn" style="margin-top:10px;background:#ff3b30;color:white;">üóë L√∂schen</button>
  </div>
</div>

<div id="screen-report" class="screen">
  <div class="card" id="shiftReport">
    <div class="label">Schichtbericht</div>
    <div class="row"><span>Anzahl Adressen</span><b id="reportCount">0</b></div>
    <div class="row"><span>Summe Betrag (‚Ç¨)</span><b id="reportSum">0.00</b></div>
    <div class="row"><span>Lohn (‚Ç¨)</span><input id="lohn" type="number" step="0.01"></div>
    <div class="row"><span>Benzin (‚Ç¨)</span><input id="benzin" type="number" step="0.01"></div>
    <div class="row"><span>Sonstige (‚Ç¨)</span><input id="sonstige" type="number" step="0.01"></div>
    <div class="row"><span><b>Ergebnis (‚Ç¨)</b></span><b id="reportResult">0.00</b></div>
  </div>
</div>

<!-- ===== Edit Box ===== -->
<div id="editBox">
  <div class="edit-content">
    <h3 style="text-align:center;margin-top:0;">Eintrag</h3>
    <label class="label">Adresse</label>
    <input id="editAddress" type="search" autocomplete="off">
    <div id="streetHints"></div>
    <label class="label">Telefon</label>
    <input id="editPhone" type="tel">
    <label class="label">Betrag (‚Ç¨)</label>
    <input id="editAmount" type="number" step="0.01">
    <div style="display:flex; gap:10px; margin-top:15px;">
      <button id="editCancel" class="gray">Abbrechen</button>
      <button id="editSave" class="google">Speichern</button>
    </div>
  </div>
</div>

<!-- ===== Confirm Box ===== -->
<div id="confirmBox">
  <div class="confirm-content">
    <div style="font-size:16px; margin-bottom:20px;">Eintrag wirklich l√∂schen?</div>
    <div style="display:flex; gap:10px;">
      <button id="cancelDel" style="flex:1;padding:12px;border-radius:12px;border:none;background:#ddd;">Abbrechen</button>
      <button id="okDel" style="flex:1;padding:12px;border-radius:12px;border:none;background:#ff3b30;color:white;">L√∂schen</button>
    </div>
  </div>
</div>

<!-- ===== Bottom Navigation ===== -->
<div class="bottom-nav">
  <button data-screen="scanner">üì∑<br>Scanner</button>
  <button data-screen="home">üè†<br>Home</button>
  <button data-screen="report">üìä<br>Bericht</button>
</div>

<script>
// ===== Variables =====
let qr, scannerRunning=false, scanTimer=null;
let history = JSON.parse(localStorage.getItem("qrHistory")||"[]");
const today = new Date().toISOString().slice(0,10);
history = history.filter(i=>i.date===today);
localStorage.setItem("qrHistory",JSON.stringify(history));
let selectedIndex=null, lastData={};

// ===== Elements =====
const addressEl = document.getElementById("address");
const phoneEl = document.getElementById("phone");
const amountEl = document.getElementById("amount");
const callBtn = document.getElementById("callBtn");
const googleBtn = document.getElementById("googleBtn");
const appleBtn = document.getElementById("appleBtn");
const scanToggle = document.getElementById("scanToggle");

const editBox = document.getElementById("editBox");
const editAddress = document.getElementById("editAddress");
const editPhone = document.getElementById("editPhone");
const editAmount = document.getElementById("editAmount");
const editSave = document.getElementById("editSave");
const editCancel = document.getElementById("editCancel");
const streetHints = document.getElementById("streetHints");

const screens = {
  scanner: document.getElementById("screen-scanner"),
  home: document.getElementById("screen-home"),
  report: document.getElementById("screen-report")
};
const navButtons = document.querySelectorAll(".bottom-nav button");

// ===== Navigation =====
function showScreen(name){
  if(scannerRunning && name!=="scanner") stopScanner();
  Object.values(screens).forEach(s=>s.classList.remove("active"));
  navButtons.forEach(b=>b.classList.remove("active"));
  screens[name].classList.add("active");
  document.querySelector(`[data-screen="${name}"]`).classList.add("active");
}
navButtons.forEach(btn=>btn.onclick=()=>showScreen(btn.dataset.screen));
showScreen("home"); // —Å—Ç–∞—Ä—Ç —Å –î–æ–º–∏–∫–∞

// ===== Functions =====
// —Å—é–¥–∞ –≤—Å—Ç–∞–≤–∏–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏: fill, renderHistory, parseQR, startScanner, stopScanner, —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —É–¥–∞–ª–µ–Ω–∏–µ, –æ—Ç—á–µ—Ç, –ø–æ–¥—Å–∫–∞–∑–∫–∏

let editIndex = null;

function openEdit(item = {}, index = null) {
  editIndex = index;
  editAddress.value = item.address || "";
  editPhone.value = item.phone || "";
  editAmount.value = item.amount || "";
  editBox.style.display = "block";
}

function closeEdit() {
  editBox.style.display = "none";
  editIndex = null;
  streetHints.innerHTML = "";
}

editCancel.onclick = closeEdit;
/* ---------------- Anzeige ---------------- */
function fill(item, index) {
  selectedIndex = index;
  lastData = item;

  addressEl.textContent = item.address || "‚Äî";
  phoneEl.textContent = item.phone || "‚Äî";
  amountEl.textContent = item.amount || "‚Äî";

  callBtn.disabled = !item.phone;
  googleBtn.disabled = !item.address;
  appleBtn.disabled = !item.address;

  renderHistory();
  updateShiftReport();
}

/* ---------------- Verlauf ---------------- */
function renderHistory() {
  const box = document.getElementById("history");
  box.innerHTML = "";

  history.forEach((item, index) => {
    const div = document.createElement("div");
    div.className =
      "history-item" +
      (index === selectedIndex ? " active" : "") +
      (item.done ? " done" : "");

    div.innerHTML = `
      <b>${item.address || "‚Äî"}</b>
      üìû ${item.phone || "‚Äî"} | üí∂ ${item.amount || "‚Äî"}
      <div style="font-size:12px;color:#888">${item.time}</div>
    `;

    // üëâ –¢–ê–ü ‚Äî –∫–∞–∫ –±—ã–ª–æ
    div.onclick = () => fill(item, index);

    // üëá –°–í–ê–ô–ü
    let startX = 0;

    div.addEventListener("touchstart", e => {
      startX = e.touches[0].clientX;
    });

    div.addEventListener("touchend", e => {
      const endX = e.changedTouches[0].clientX;
      const diff = endX - startX;

      // üëâ –≤–ø—Ä–∞–≤–æ ‚Äî erledigt
      if (diff > 60) {
        item.done = true;
        localStorage.setItem("qrHistory", JSON.stringify(history));
        renderHistory();
      }

      // üëà –≤–ª–µ–≤–æ ‚Äî –≤–µ—Ä–Ω—É—Ç—å
      if (diff < -60) {
        item.done = false;
        localStorage.setItem("qrHistory", JSON.stringify(history));
        renderHistory();
      }
    });

    box.appendChild(div);
  });
}

/* ---------------- QR PARSE (–ï–î–ò–ù–°–¢–í–ï–ù–ù–ê–Ø) ---------------- */
function parseQR(text) {
  let address="", phone="", amount="";
  const parts = text.split(";");

  if (parts[0] && !parts[0].includes("=")) address = parts[0].trim();
  parts.forEach(p => {
    if (p.startsWith("T=")) phone = p.substring(2).trim();
    if (p.startsWith("B=")) amount = p.substring(2).replace(",", ".").trim();
  });

  const now = new Date();
  const item = {
    address,
    phone,
    amount,
    time: now.toLocaleTimeString(),
    date: now.toISOString().slice(0,10),
    done: false
  };
  // ‚ùå –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø–æ–ª–Ω—ã–π –¥—É–±–ª–∏–∫–∞—Ç (–∞–¥—Ä–µ—Å + —Ç–µ–ª–µ—Ñ–æ–Ω + Betrag)
    const isDuplicate = history.some(i =>
      i.address === address &&
      i.phone === phone &&
      i.amount === amount &&
      i.date === now.toISOString().slice(0,10)
    );

    if (isDuplicate) {
      // –µ—Å–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –∑–∞–ø–∏—Å—å
      const index = history.findIndex(i =>
        i.address === address &&
        i.phone === phone &&
        i.amount === amount
      );
      fill(history[index], index);
      return;
    }

  history.unshift(item);
  history = history.slice(0, 50);
  localStorage.setItem("qrHistory", JSON.stringify(history));

  fill(item, 0);
}

/* ---------------- Scanner ---------------- */
function startScanner() {
  if (scannerRunning) return;

  document.getElementById("reader").innerHTML = '<div class="scan-frame"></div>';
  qr = new Html5Qrcode("reader");
  scannerRunning = true;

  scanToggle.textContent = "‚èπ Stoppen";
  scanToggle.classList.add("off");

  qr.start(
    { facingMode: "environment" },
    { fps: 20, qrbox: { width: 220, height: 220 } },
    text => {
      stopScanner();
      parseQR(text);
    }
  );

  scanTimer = setTimeout(stopScanner, 20000);
}

function stopScanner() {
  if (!scannerRunning) return;
  qr.stop().catch(()=>{});
  scannerRunning = false;
  scanToggle.textContent = "‚ñ∂Ô∏è Scannen";
  scanToggle.classList.remove("off");
  clearTimeout(scanTimer);
}

scanToggle.onclick = () => scannerRunning ? stopScanner() : startScanner();



document.getElementById("editBtn").onclick = () => {
  if (selectedIndex === null) {
    alert("Bitte einen Eintrag ausw√§hlen");
    return;
  }
  openEdit(history[selectedIndex], selectedIndex);
};

document.getElementById("addBtn").onclick = () => {
  openEdit();
};

editSave.onclick = () => {
  if (!editAddress.value.trim()) {
    alert("Adresse fehlt");
    return;
  }

  const now = new Date();
  const item = {
    address: editAddress.value.trim(),
    phone: editPhone.value.trim(),
    amount: editAmount.value.replace(",", "."),
    time: now.toLocaleTimeString(),
    date: now.toISOString().slice(0,10),
    done: false
  };

  if (editIndex !== null) {
    history[editIndex] = item;
    fill(item, editIndex);
  } else {
    history.unshift(item);
    fill(item, 0);
  }

  localStorage.setItem("qrHistory", JSON.stringify(history));
  closeEdit();
  renderHistory();
  updateShiftReport();
};


/* ---------------- Aktionen ---------------- */
callBtn.onclick = () => location.href = "tel:" + lastData.phone;
googleBtn.onclick = () =>
  location.href = "https://www.google.com/maps/search/?api=1&query=" +
  encodeURIComponent(lastData.address);
appleBtn.onclick = () =>
  location.href = "https://maps.apple.com/?q=" +
  encodeURIComponent(lastData.address);

/* ---------------- L√∂schen ---------------- */
document.getElementById("deleteBtn").onclick = () => {
  if (selectedIndex === null) return;
  confirmBox.style.display = "block";
};

cancelDel.onclick = () => confirmBox.style.display = "none";

okDel.onclick = () => {
  history.splice(selectedIndex, 1);
  selectedIndex = null;
  localStorage.setItem("qrHistory", JSON.stringify(history));
  confirmBox.style.display = "none";
  renderHistory();
  updateShiftReport();
};

/* ---------------- Schichtbericht ---------------- */
function updateShiftReport() {
  const today = new Date().toISOString().slice(0,10);
  const todayItems = history.filter(i => i.date === today);

  const sum = todayItems.reduce(
    (a, i) => a + (parseFloat(i.amount) || 0),
    0
  );

  document.getElementById("reportCount").textContent = todayItems.length;
  document.getElementById("reportSum").textContent = sum.toFixed(2);

  const lohn = parseFloat(document.getElementById("lohn").value) || 0;
  const benzin = parseFloat(document.getElementById("benzin").value) || 0;
  const sonstige = parseFloat(document.getElementById("sonstige").value) || 0;

  document.getElementById("reportResult").textContent =
    (sum - lohn - benzin - sonstige).toFixed(2);
}

["lohn","benzin","sonstige"].forEach(id =>
  document.getElementById(id).addEventListener("input", updateShiftReport)
);

renderHistory();
updateShiftReport();


editCancel.onclick = closeEdit;

let streets = [];

// –ó–∞–≥—Ä—É–∑–∫–∞ —É–ª–∏—Ü –∏–∑ —Ñ–∞–π–ª–∞
fetch("Strasse.txt")
  .then(res => res.text())
  .then(text => {
    streets = text
      .split("\n")
      .map(s => s.trim())
      .filter(s => s.length > 0);

    console.log("Streets loaded:", streets.length);
  })
  .catch(err => console.error("Street file error", err));


editAddress.addEventListener("input", () => {
  const value = editAddress.value.trim().toLowerCase();
  streetHints.innerHTML = "";

  if (value.length < 2) return;

  const matches = streets
    .filter(s => s.toLowerCase().includes(value))
    .slice(0, 6); // –º–∞–∫—Å–∏–º—É–º 6 –ø–æ–¥—Å–∫–∞–∑–æ–∫

  matches.forEach(street => {
    const div = document.createElement("div");
    div.className = "street-hint";
    div.textContent = street;

    div.onclick = () => {
      editAddress.value = street;
      streetHints.innerHTML = "";
    };

    streetHints.appendChild(div);
  });
});
</script>

</body>
</html>
