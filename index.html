<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>QR Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: #f2f2f7;
  margin: 0;
  padding: 15px;
}
.app { max-width: 420px; margin: auto; }
h2 { text-align: center; margin-bottom: 6px; }

.scan-btn {
  width: 100%;
  margin: 6px 0 14px;
  background: #34c759;
  color: white;
  font-size: 16px;
  padding: 14px;
  border-radius: 14px;
  border: none;
}
.scan-btn.off { background: #aaa; }

#reader {
  position: relative;
  border-radius: 16px;
  overflow: hidden;
  background: black;
}

.scan-frame {
  position: absolute;
  top: 50%;
  left: 50%;
  width: 220px;
  height: 220px;
  transform: translate(-50%, -50%);
  border-radius: 18px;
  border: 3px solid rgba(255,255,255,0.9);
  box-shadow: 0 0 0 2000px rgba(0,0,0,0.35);
  pointer-events: none;
}

.card {
  background: white;
  border-radius: 16px;
  padding: 14px;
  margin-top: 15px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

.row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 8px 0;
  border-bottom: 1px solid #eee;
}
.row:last-child { border-bottom: none; }

.label { color: #888; font-size: 13px; }
.value { font-size: 16px; font-weight: 500; word-break: break-word; }

.call-btn {
  background: #34c759;
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-size: 18px;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
}
.call-btn:disabled { background: #ccc; }

.buttons { display: flex; gap: 10px; margin-top: 15px; }
button {
  flex: 1;
  padding: 14px;
  border-radius: 14px;
  border: none;
  font-size: 15px;
}

.google { background: #4285f4; color: white; }
.apple { background: black; color: white; }
.gray { background: #ddd; }

.history-item {
  padding: 8px;
  border-bottom: 1px solid #eee;
  font-size: 14px;
}
.history-item.active {
  background: #e5f0ff;
  border-radius: 10px;
}
.history-item b { display: block; }

/* –∫–∞—Å—Ç–æ–º–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
}
.modal-box {
  background: white;
  border-radius: 16px;
  padding: 18px;
  max-width: 300px;
  width: 90%;
  text-align: center;
}
.modal-buttons {
  display: flex;
  gap: 10px;
  margin-top: 15px;
}
.modal-buttons button {
  flex: 1;
}
</style>
</head>

<body>
<div class="app">

<h2>üì∑ QR-Scanner</h2>
<button id="scanToggle" class="scan-btn">‚ñ∂Ô∏è Scannen</button>

<div id="reader"></div>

<div class="card">
  <div class="row">
    <div>
      <div class="label">Adresse</div>
      <div class="value" id="address">‚Äî</div>
    </div>
  </div>

  <div class="row">
    <div>
      <div class="label">Telefon</div>
      <div class="value" id="phone">‚Äî</div>
    </div>
    <button class="call-btn" id="callBtn" disabled>üìû</button>
  </div>

  <div class="row">
    <div>
      <div class="label">Betrag (‚Ç¨)</div>
      <div class="value" id="amount">‚Äî</div>
    </div>
  </div>

  <div class="buttons">
    <button class="gray" id="editBtn">‚úèÔ∏è Bearbeiten</button>
    <button class="gray" id="addBtn">‚ûï Manuell</button>
  </div>
</div>

<div class="buttons">
  <button class="google" id="googleBtn" disabled>Google Maps</button>
  <button class="apple" id="appleBtn" disabled>Apple Maps</button>
</div>

<div class="card">
  <div class="label">Heutige Eintr√§ge</div>
  <div id="history"></div>
  <button id="deleteBtn" style="margin-top:10px;background:#ff3b30;color:white;">
    üóë L√∂schen
  </button>
</div>

</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal" id="confirmModal">
  <div class="modal-box">
    <b>Diesen Eintrag wirklich l√∂schen?</b>
    <div class="modal-buttons">
      <button class="gray" onclick="closeModal()">Abbrechen</button>
      <button style="background:#ff3b30;color:white;" onclick="confirmDelete()">OK</button>
    </div>
  </div>
</div>

<script>
/* ===== Datum ===== */
function todayKey() {
  const d = new Date();
  return d.getFullYear() + "-" +
    String(d.getMonth()+1).padStart(2,"0") + "-" +
    String(d.getDate()).padStart(2,"0");
}

/* ===== Daten ===== */
let history = JSON.parse(localStorage.getItem("qrHistory") || "[]");
let selectedIndex = null;
let lastData = {};
let qr, scannerRunning=false, scanTimer;

/* ===== Auto-Cleanup ===== */
function cleanupOldEntries() {
  const today = todayKey();
  history = history.filter(i => i.date === today);
  localStorage.setItem("qrHistory", JSON.stringify(history));
}

/* ===== Anzeige ===== */
function fill(item, index) {
  selectedIndex = index;
  lastData = item;

  address.textContent = item.address || "‚Äî";
  phone.textContent = item.phone || "‚Äî";
  amount.textContent = item.amount || "‚Äî";

  callBtn.disabled = !item.phone;
  googleBtn.disabled = !item.address;
  appleBtn.disabled = !item.address;

  renderHistory();
}

function renderHistory() {
  historyBox.innerHTML = "";
  history.forEach((item,i)=>{
    const d=document.createElement("div");
    d.className="history-item"+(i===selectedIndex?" active":"");
    d.innerHTML=`<b>${item.address||"‚Äî"}</b>
    üìû ${item.phone||"‚Äî"} | üí∂ ${item.amount||"‚Äî"}
    <div style="font-size:12px;color:#888">${item.time}</div>`;
    d.onclick=()=>fill(item,i);
    historyBox.appendChild(d);
  });
}

/* ===== QR ===== */
function parseQR(text) {
  let address="", phone="", amount="";
  const p=text.split(";");
  if(p[0]&&!p[0].includes("=")) address=p[0].trim();
  p.forEach(x=>{
    if(x.startsWith("T=")) phone=x.slice(2);
    if(x.startsWith("B=")) amount=x.slice(2).replace(",",".");
  });

  const item={address,phone,amount,time:new Date().toLocaleString(),date:todayKey()};
  history.unshift(item);
  history=history.slice(0,50);
  localStorage.setItem("qrHistory",JSON.stringify(history));
  fill(item,0);
}

/* ===== Scanner ===== */
function startScanner(){
  if(scannerRunning) return;
  reader.innerHTML='<div class="scan-frame"></div>';
  qr=new Html5Qrcode("reader");
  scannerRunning=true;
  scanToggle.textContent="‚èπ Stop";
  scanToggle.classList.add("off");

  qr.start({facingMode:"environment"},{fps:20,qrbox:{width:220,height:220}},t=>{
    stopScanner(); parseQR(t);
  });
  scanTimer=setTimeout(stopScanner,5000);
}

function stopScanner(){
  if(!scannerRunning) return;
  qr.stop().catch(()=>{});
  scannerRunning=false;
  scanToggle.textContent="‚ñ∂Ô∏è Scannen";
  scanToggle.classList.remove("off");
  clearTimeout(scanTimer);
}

scanToggle.onclick=()=>scannerRunning?stopScanner():startScanner();

/* ===== Aktionen ===== */
callBtn.onclick=()=>location.href="tel:"+lastData.phone;
googleBtn.onclick=()=>location.href="https://www.google.com/maps/search/?query="+encodeURIComponent(lastData.address);
appleBtn.onclick=()=>location.href="https://maps.apple.com/?q="+encodeURIComponent(lastData.address);

/* ===== Edit / Add ===== */
function editPrompt(item={}){
  const a=prompt("Adresse:",item.address||""); if(a===null)return;
  const p=prompt("Telefon:",item.phone||""); if(p===null)return;
  const b=prompt("Betrag:",item.amount||""); if(b===null)return;
  return{address:a,phone:p,amount:b.replace(",","."),time:new Date().toLocaleString(),date:todayKey()};
}

editBtn.onclick=()=>{
  if(selectedIndex===null) return;
  const e=editPrompt(history[selectedIndex]);
  if(!e) return;
  history[selectedIndex]=e;
  localStorage.setItem("qrHistory",JSON.stringify(history));
  fill(e,selectedIndex);
};

addBtn.onclick=()=>{
  const e=editPrompt();
  if(!e) return;
  history.unshift(e);
  localStorage.setItem("qrHistory",JSON.stringify(history));
  fill(e,0);
};

/* ===== Delete ===== */
deleteBtn.onclick=()=>{
  if(selectedIndex===null) return;
  confirmModal.style.display="flex";
};

function confirmDelete(){
  history.splice(selectedIndex,1);
  selectedIndex=null;
  localStorage.setItem("qrHistory",JSON.stringify(history));
  closeModal();
  renderHistory();
}
function closeModal(){ confirmModal.style.display="none"; }

/* ===== Init ===== */
const address=document.getElementById("address");
const phone=document.getElementById("phone");
const amount=document.getElementById("amount");
const historyBox=document.getElementById("history");

cleanupOldEntries();
renderHistory();
</script>

</body>
  </html>
